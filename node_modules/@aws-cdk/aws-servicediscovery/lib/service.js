"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/cdk");
const alias_target_instance_1 = require("./alias-target-instance");
const cname_instance_1 = require("./cname-instance");
const ip_instance_1 = require("./ip-instance");
const namespace_1 = require("./namespace");
const non_ip_instance_1 = require("./non-ip-instance");
const servicediscovery_generated_1 = require("./servicediscovery.generated");
/**
 * Define a CloudMap Service
 */
class Service extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const namespaceType = props.namespace.type;
        // Validations
        if (namespaceType === namespace_1.NamespaceType.Http && (props.routingPolicy || props.dnsRecordType)) {
            throw new Error('Cannot specify `routingPolicy` or `dnsRecord` when using an HTTP namespace.');
        }
        if (props.healthCheck && props.customHealthCheck) {
            throw new Error('Cannot specify both `healthCheckConfig` and `healthCheckCustomConfig`.');
        }
        if (namespaceType === namespace_1.NamespaceType.DnsPrivate && props.healthCheck) {
            throw new Error('Cannot specify `healthCheckConfig` for a Private DNS namespace.');
        }
        if (props.routingPolicy === RoutingPolicy.Multivalue
            && props.dnsRecordType === DnsRecordType.CNAME) {
            throw new Error('Cannot use `CNAME` record when routing policy is `Multivalue`.');
        }
        // Additional validation for eventual attachment of LBs
        // The same validation happens later on during the actual attachment
        // of LBs, but we need the property for the correct configuration of
        // routingPolicy anyway, so might as well do the validation as well.
        if (props.routingPolicy === RoutingPolicy.Multivalue
            && props.loadBalancer) {
            throw new Error('Cannot register loadbalancers when routing policy is `Multivalue`.');
        }
        if (props.healthCheck
            && props.healthCheck.type === HealthCheckType.Tcp
            && props.healthCheck.resourcePath) {
            throw new Error('Cannot specify `resourcePath` when using a `TCP` health check.');
        }
        // Set defaults where necessary
        const routingPolicy = (props.dnsRecordType === DnsRecordType.CNAME) || props.loadBalancer
            ? RoutingPolicy.Weighted
            : RoutingPolicy.Multivalue;
        const dnsRecordType = props.dnsRecordType || DnsRecordType.A;
        if (props.loadBalancer
            && (!(dnsRecordType === DnsRecordType.A
                || dnsRecordType === DnsRecordType.AAAA
                || dnsRecordType === DnsRecordType.A_AAAA))) {
            throw new Error('Must support `A` or `AAAA` records to register loadbalancers.');
        }
        const dnsConfig = props.namespace.type === namespace_1.NamespaceType.Http
            ? undefined
            : {
                dnsRecords: renderDnsRecords(dnsRecordType, props.dnsTtlSec),
                namespaceId: props.namespace.namespaceId,
                routingPolicy,
            };
        const healthCheckConfigDefaults = {
            type: HealthCheckType.Http,
            failureThreshold: 1,
            resourcePath: props.healthCheck && props.healthCheck.type !== HealthCheckType.Tcp
                ? '/'
                : undefined
        };
        const healthCheckConfig = props.healthCheck && Object.assign({}, healthCheckConfigDefaults, props.healthCheck);
        const healthCheckCustomConfig = props.customHealthCheck;
        // Create service
        const service = new servicediscovery_generated_1.CfnService(this, 'Resource', {
            name: props.name,
            description: props.description,
            dnsConfig,
            healthCheckConfig,
            healthCheckCustomConfig,
            namespaceId: props.namespace.namespaceId
        });
        this.serviceName = service.serviceName;
        this.serviceArn = service.serviceArn;
        this.serviceId = service.serviceId;
        this.namespace = props.namespace;
        this.dnsRecordType = dnsRecordType;
        this.routingPolicy = routingPolicy;
    }
    /**
     * Registers an ELB as a new instance with unique name instanceId in this service.
     */
    registerLoadBalancer(id, loadBalancer, customAttributes) {
        return new alias_target_instance_1.AliasTargetInstance(this, id, {
            service: this,
            dnsName: loadBalancer.asAliasRecordTarget().dnsName,
            customAttributes
        });
    }
    /**
     * Registers a resource that is accessible using values other than an IP address or a domain name (CNAME).
     */
    registerNonIpInstance(props) {
        return new non_ip_instance_1.NonIpInstance(this, "NonIpInstance", {
            service: this,
            instanceId: props.instanceId,
            customAttributes: props.customAttributes
        });
    }
    /**
     * Registers a resource that is accessible using an IP address.
     */
    registerIpInstance(props) {
        return new ip_instance_1.IpInstance(this, "IpInstance", {
            service: this,
            instanceId: props.instanceId,
            ipv4: props.ipv4,
            ipv6: props.ipv6,
            port: props.port,
            customAttributes: props.customAttributes
        });
    }
    /**
     * Registers a resource that is accessible using a CNAME.
     */
    registerCnameInstance(props) {
        return new cname_instance_1.CnameInstance(this, "CnameInstance", {
            service: this,
            instanceId: props.instanceId,
            instanceCname: props.instanceCname,
            customAttributes: props.customAttributes
        });
    }
}
exports.Service = Service;
function renderDnsRecords(dnsRecordType, dnsTtlSec) {
    const ttl = dnsTtlSec !== undefined ? dnsTtlSec : 60;
    if (dnsRecordType === DnsRecordType.A_AAAA) {
        return [{
                type: DnsRecordType.A,
                ttl
            }, {
                type: DnsRecordType.AAAA,
                ttl,
            }];
    }
    else {
        return [{ type: dnsRecordType, ttl }];
    }
}
var DnsRecordType;
(function (DnsRecordType) {
    /**
     * An A record
     */
    DnsRecordType["A"] = "A";
    /**
     * An AAAA record
     */
    DnsRecordType["AAAA"] = "AAAA";
    /**
     * Both an A and AAAA record
     */
    DnsRecordType["A_AAAA"] = "A, AAAA";
    /**
     * A Srv record
     */
    DnsRecordType["SRV"] = "SRV";
    /**
     * A CNAME record
     */
    DnsRecordType["CNAME"] = "CNAME";
})(DnsRecordType = exports.DnsRecordType || (exports.DnsRecordType = {}));
var RoutingPolicy;
(function (RoutingPolicy) {
    /**
     * Route 53 returns the applicable value from one randomly selected instance from among the instances that you
     * registered using the same service.
     */
    RoutingPolicy["Weighted"] = "WEIGHTED";
    /**
     * If you define a health check for the service and the health check is healthy, Route 53 returns the applicable value
     * for up to eight instances.
     */
    RoutingPolicy["Multivalue"] = "MULTIVALUE";
})(RoutingPolicy = exports.RoutingPolicy || (exports.RoutingPolicy = {}));
var HealthCheckType;
(function (HealthCheckType) {
    /**
     * Route 53 tries to establish a TCP connection. If successful, Route 53 submits an HTTP request and waits for an HTTP
     * status code of 200 or greater and less than 400.
     */
    HealthCheckType["Http"] = "HTTP";
    /**
     * Route 53 tries to establish a TCP connection. If successful, Route 53 submits an HTTPS request and waits for an
     * HTTP status code of 200 or greater and less than 400.  If you specify HTTPS for the value of Type, the endpoint
     * must support TLS v1.0 or later.
     */
    HealthCheckType["Https"] = "HTTPS";
    /**
     * Route 53 tries to establish a TCP connection.
     * If you specify TCP for Type, don't specify a value for ResourcePath.
     */
    HealthCheckType["Tcp"] = "TCP";
})(HealthCheckType = exports.HealthCheckType || (exports.HealthCheckType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxvQ0FBcUM7QUFDckMsbUVBQThEO0FBQzlELHFEQUEwRTtBQUUxRSwrQ0FBZ0U7QUFDaEUsMkNBQXdEO0FBQ3hELHVEQUEwRTtBQUMxRSw2RUFBMEQ7QUF1SDFEOztHQUVHO0FBQ0gsTUFBYSxPQUFRLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUErQnhDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBbUI7UUFDL0QsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztRQUUzQyxjQUFjO1FBQ2QsSUFBSSxhQUFhLEtBQUsseUJBQWEsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUN4RixNQUFNLElBQUksS0FBSyxDQUFDLDZFQUE2RSxDQUFDLENBQUM7U0FDaEc7UUFFRCxJQUFJLEtBQUssQ0FBQyxXQUFXLElBQUksS0FBSyxDQUFDLGlCQUFpQixFQUFFO1lBQ2hELE1BQU0sSUFBSSxLQUFLLENBQUMsd0VBQXdFLENBQUMsQ0FBQztTQUMzRjtRQUVELElBQUksYUFBYSxLQUFLLHlCQUFhLENBQUMsVUFBVSxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDbkUsTUFBTSxJQUFJLEtBQUssQ0FBQyxpRUFBaUUsQ0FBQyxDQUFDO1NBQ3BGO1FBRUQsSUFBSSxLQUFLLENBQUMsYUFBYSxLQUFLLGFBQWEsQ0FBQyxVQUFVO2VBQzdDLEtBQUssQ0FBQyxhQUFhLEtBQUssYUFBYSxDQUFDLEtBQUssRUFBRTtZQUNsRCxNQUFNLElBQUksS0FBSyxDQUFDLGdFQUFnRSxDQUFDLENBQUM7U0FDbkY7UUFFRCx1REFBdUQ7UUFDdkQsb0VBQW9FO1FBQ3BF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LHVCQUFlLFFBbUIxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByb3V0ZTUzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXJvdXRlNTMnKTtcbmltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jZGsnKTtcbmltcG9ydCB7IEFsaWFzVGFyZ2V0SW5zdGFuY2UgfSBmcm9tICcuL2FsaWFzLXRhcmdldC1pbnN0YW5jZSc7XG5pbXBvcnQgeyBDbmFtZUluc3RhbmNlLCBDbmFtZUluc3RhbmNlQmFzZVByb3BzICB9IGZyb20gJy4vY25hbWUtaW5zdGFuY2UnO1xuaW1wb3J0IHsgSUluc3RhbmNlIH0gZnJvbSAnLi9pbnN0YW5jZSc7XG5pbXBvcnQgeyBJcEluc3RhbmNlLCBJcEluc3RhbmNlQmFzZVByb3BzIH0gZnJvbSAnLi9pcC1pbnN0YW5jZSc7XG5pbXBvcnQgeyBJTmFtZXNwYWNlLCBOYW1lc3BhY2VUeXBlIH0gZnJvbSAnLi9uYW1lc3BhY2UnO1xuaW1wb3J0IHsgTm9uSXBJbnN0YW5jZSwgTm9uSXBJbnN0YW5jZUJhc2VQcm9wcyB9IGZyb20gJy4vbm9uLWlwLWluc3RhbmNlJztcbmltcG9ydCB7IENmblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VkaXNjb3ZlcnkuZ2VuZXJhdGVkJztcblxuZXhwb3J0IGludGVyZmFjZSBJU2VydmljZSBleHRlbmRzIGNkay5JQ29uc3RydWN0IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIENsb3VkbWFwIFNlcnZpY2UuXG4gICAqL1xuICByZWFkb25seSBzZXJ2aWNlTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiAgVGhlIG5hbWVzcGFjZSBmb3IgdGhlIENsb3VkbWFwIFNlcnZpY2UuXG4gICAqL1xuICByZWFkb25seSBuYW1lc3BhY2U6IElOYW1lc3BhY2U7XG5cbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgbmFtZXNwYWNlIHRoYXQgeW91IHdhbnQgdG8gdXNlIGZvciBETlMgY29uZmlndXJhdGlvbi5cbiAgICovXG4gIHJlYWRvbmx5IHNlcnZpY2VJZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgQXJuIG9mIHRoZSBuYW1lc3BhY2UgdGhhdCB5b3Ugd2FudCB0byB1c2UgZm9yIEROUyBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgc2VydmljZUFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgRG5zUmVjb3JkVHlwZSB1c2VkIGJ5IHRoZSBzZXJ2aWNlXG4gICAqL1xuICByZWFkb25seSBkbnNSZWNvcmRUeXBlOiBEbnNSZWNvcmRUeXBlO1xuXG4gIC8qKlxuICAgKiBUaGUgUm91dGluZyBQb2xpY3kgdXNlZCBieSB0aGUgc2VydmljZVxuICAgKi9cbiAgcmVhZG9ubHkgcm91dGluZ1BvbGljeTogUm91dGluZ1BvbGljeTtcbn1cblxuLyoqXG4gKiBCYXNpYyBwcm9wcyBuZWVkZWQgdG8gY3JlYXRlIGEgc2VydmljZSBpbiBhIGdpdmVuIG5hbWVzcGFjZS4gVXNlZCBieSBIdHRwTmFtZXNwYWNlLmNyZWF0ZVNlcnZpY2VcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCYXNlU2VydmljZVByb3BzIHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIFNlcnZpY2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IENsb3VkRm9ybWF0aW9uLWdlbmVyYXRlZCBuYW1lXG4gICAqL1xuICByZWFkb25seSBuYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBIGRlc2NyaXB0aW9uIG9mIHRoZSBzZXJ2aWNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCBub25lXG4gICAqL1xuICByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcblxuICAvKipcbiAgICogU2V0dGluZ3MgZm9yIGFuIG9wdGlvbmFsIGhlYWx0aCBjaGVjay4gIElmIHlvdSBzcGVjaWZ5IGhlYWx0aCBjaGVjayBzZXR0aW5ncywgQVdTIENsb3VkIE1hcCBhc3NvY2lhdGVzIHRoZSBoZWFsdGhcbiAgICogY2hlY2sgd2l0aCB0aGUgcmVjb3JkcyB0aGF0IHlvdSBzcGVjaWZ5IGluIERuc0NvbmZpZy4gT25seSBvbmUgb2YgaGVhbHRoQ2hlY2tDb25maWcgb3IgaGVhbHRoQ2hlY2tDdXN0b21Db25maWcgY2FuXG4gICAqIGJlIHNwZWNpZmllZC4gTm90IHZhbGlkIGZvciBQcml2YXRlRG5zTmFtZXNwYWNlcy4gSWYgeW91IHVzZSBoZWFsdGhDaGVjaywgeW91IGNhbiBvbmx5IHJlZ2lzdGVyIElQIGluc3RhbmNlcyB0b1xuICAgKiB0aGlzIHNlcnZpY2UuXG4gICAqXG4gICAqIEBkZWZhdWx0IG5vbmVcbiAgICovXG4gIHJlYWRvbmx5IGhlYWx0aENoZWNrPzogSGVhbHRoQ2hlY2tDb25maWc7XG5cbiAgLyoqXG4gICAqIFN0cnVjdHVyZSBjb250YWluaW5nIGZhaWx1cmUgdGhyZXNob2xkIGZvciBhIGN1c3RvbSBoZWFsdGggY2hlY2tlci5cbiAgICogT25seSBvbmUgb2YgaGVhbHRoQ2hlY2tDb25maWcgb3IgaGVhbHRoQ2hlY2tDdXN0b21Db25maWcgY2FuIGJlIHNwZWNpZmllZC5cbiAgICogU2VlOiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xvdWQtbWFwL2xhdGVzdC9hcGkvQVBJX0hlYWx0aENoZWNrQ3VzdG9tQ29uZmlnLmh0bWxcbiAgICpcbiAgICogQGRlZmF1bHQgbm9uZVxuICAgKi9cbiAgcmVhZG9ubHkgY3VzdG9tSGVhbHRoQ2hlY2s/OiBIZWFsdGhDaGVja0N1c3RvbUNvbmZpZztcbn1cblxuLyoqXG4gKiBTZXJ2aWNlIHByb3BzIG5lZWRlZCB0byBjcmVhdGUgYSBzZXJ2aWNlIGluIGEgZ2l2ZW4gbmFtZXNwYWNlLiBVc2VkIGJ5IGNyZWF0ZVNlcnZpY2UoKSBmb3IgUHJpdmF0ZURuc05hbWVzcGFjZSBhbmRcbiAqIFB1YmxpY0Ruc05hbWVzcGFjZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIERuc1NlcnZpY2VQcm9wcyBleHRlbmRzIEJhc2VTZXJ2aWNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIEROUyB0eXBlIG9mIHRoZSByZWNvcmQgdGhhdCB5b3Ugd2FudCBBV1MgQ2xvdWQgTWFwIHRvIGNyZWF0ZS4gU3VwcG9ydGVkIHJlY29yZCB0eXBlc1xuICAgKiBpbmNsdWRlIEEsIEFBQUEsIEEgYW5kIEFBQUEgKEFfQUFBQSksIENOQU1FLCBhbmQgU1JWLlxuICAgKlxuICAgKiBAZGVmYXVsdCBBXG4gICAqL1xuICByZWFkb25seSBkbnNSZWNvcmRUeXBlPzogRG5zUmVjb3JkVHlwZTtcblxuICAvKipcbiAgICogVGhlIGFtb3VudCBvZiB0aW1lLCBpbiBzZWNvbmRzLCB0aGF0IHlvdSB3YW50IEROUyByZXNvbHZlcnMgdG8gY2FjaGUgdGhlIHNldHRpbmdzIGZvciB0aGlzXG4gICAqIHJlY29yZC5cbiAgICpcbiAgICogQGRlZmF1bHQgNjBcbiAgICovXG4gIHJlYWRvbmx5IGRuc1R0bFNlYz86IG51bWJlcjtcblxuICAvKipcbiAgICogVGhlIHJvdXRpbmcgcG9saWN5IHRoYXQgeW91IHdhbnQgdG8gYXBwbHkgdG8gYWxsIEROUyByZWNvcmRzIHRoYXQgQVdTIENsb3VkIE1hcCBjcmVhdGVzIHdoZW4geW91XG4gICAqIHJlZ2lzdGVyIGFuIGluc3RhbmNlIGFuZCBzcGVjaWZ5IHRoaXMgc2VydmljZS5cbiAgICpcbiAgICogQGRlZmF1bHQgV0VJR0hURUQgZm9yIENOQU1FIHJlY29yZHMgYW5kIHdoZW4gbG9hZEJhbGFuY2VyIGlzIHRydWUsIE1VTFRJVkFMVUUgb3RoZXJ3aXNlXG4gICAqL1xuICByZWFkb25seSByb3V0aW5nUG9saWN5PzogUm91dGluZ1BvbGljeTtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhpcyBzZXJ2aWNlIHdpbGwgaGF2ZSBhbiBFbGFzdGljIExvYWRCYWxhbmNlciByZWdpc3RlcmVkIHRvIGl0IGFzIGFuIEFsaWFzVGFyZ2V0SW5zdGFuY2UuXG4gICAqXG4gICAqIFNldHRpbmcgdGhpcyB0byBgdHJ1ZWAgY29ycmVjdGx5IGNvbmZpZ3VyZXMgdGhlIGByb3V0aW5nUG9saWN5YFxuICAgKiBhbmQgcGVyZm9ybXMgc29tZSBhZGRpdGlvbmFsIHZhbGlkYXRpb24uXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBsb2FkQmFsYW5jZXI/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZpY2VQcm9wcyBleHRlbmRzIERuc1NlcnZpY2VQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIG5hbWVzcGFjZSB0aGF0IHlvdSB3YW50IHRvIHVzZSBmb3IgRE5TIGNvbmZpZ3VyYXRpb24uXG4gICAqL1xuICByZWFkb25seSBuYW1lc3BhY2U6IElOYW1lc3BhY2U7XG59XG5cbi8qKlxuICogRGVmaW5lIGEgQ2xvdWRNYXAgU2VydmljZVxuICovXG5leHBvcnQgY2xhc3MgU2VydmljZSBleHRlbmRzIGNkay5Db25zdHJ1Y3QgaW1wbGVtZW50cyBJU2VydmljZSB7XG4gIC8qKlxuICAgKiBBIG5hbWUgZm9yIHRoZSBDbG91ZG1hcCBTZXJ2aWNlLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHNlcnZpY2VOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqICBUaGUgbmFtZXNwYWNlIGZvciB0aGUgQ2xvdWRtYXAgU2VydmljZS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBuYW1lc3BhY2U6IElOYW1lc3BhY2U7XG5cbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgbmFtZXNwYWNlIHRoYXQgeW91IHdhbnQgdG8gdXNlIGZvciBETlMgY29uZmlndXJhdGlvbi5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzZXJ2aWNlSWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIEFybiBvZiB0aGUgbmFtZXNwYWNlIHRoYXQgeW91IHdhbnQgdG8gdXNlIGZvciBETlMgY29uZmlndXJhdGlvbi5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzZXJ2aWNlQXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBEbnNSZWNvcmRUeXBlIHVzZWQgYnkgdGhlIHNlcnZpY2VcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBkbnNSZWNvcmRUeXBlOiBEbnNSZWNvcmRUeXBlO1xuXG4gIC8qKlxuICAgKiBUaGUgUm91dGluZyBQb2xpY3kgdXNlZCBieSB0aGUgc2VydmljZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHJvdXRpbmdQb2xpY3k6IFJvdXRpbmdQb2xpY3k7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBTZXJ2aWNlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgY29uc3QgbmFtZXNwYWNlVHlwZSA9IHByb3BzLm5hbWVzcGFjZS50eXBlO1xuXG4gICAgLy8gVmFsaWRhdGlvbnNcbiAgICBpZiAobmFtZXNwYWNlVHlwZSA9PT0gTmFtZXNwYWNlVHlwZS5IdHRwICYmIChwcm9wcy5yb3V0aW5nUG9saWN5IHx8IHByb3BzLmRuc1JlY29yZFR5cGUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzcGVjaWZ5IGByb3V0aW5nUG9saWN5YCBvciBgZG5zUmVjb3JkYCB3aGVuIHVzaW5nIGFuIEhUVFAgbmFtZXNwYWNlLicpO1xuICAgIH1cblxuICAgIGlmIChwcm9wcy5oZWFsdGhDaGVjayAmJiBwcm9wcy5jdXN0b21IZWFsdGhDaGVjaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc3BlY2lmeSBib3RoIGBoZWFsdGhDaGVja0NvbmZpZ2AgYW5kIGBoZWFsdGhDaGVja0N1c3RvbUNvbmZpZ2AuJyk7XG4gICAgfVxuXG4gICAgaWYgKG5hbWVzcGFjZVR5cGUgPT09IE5hbWVzcGFjZVR5cGUuRG5zUHJpdmF0ZSAmJiBwcm9wcy5oZWFsdGhDaGVjaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc3BlY2lmeSBgaGVhbHRoQ2hlY2tDb25maWdgIGZvciBhIFByaXZhdGUgRE5TIG5hbWVzcGFjZS4nKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMucm91dGluZ1BvbGljeSA9PT0gUm91dGluZ1BvbGljeS5NdWx0aXZhbHVlXG4gICAgICAgICYmIHByb3BzLmRuc1JlY29yZFR5cGUgPT09IERuc1JlY29yZFR5cGUuQ05BTUUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSBgQ05BTUVgIHJlY29yZCB3aGVuIHJvdXRpbmcgcG9saWN5IGlzIGBNdWx0aXZhbHVlYC4nKTtcbiAgICB9XG5cbiAgICAvLyBBZGRpdGlvbmFsIHZhbGlkYXRpb24gZm9yIGV2ZW50dWFsIGF0dGFjaG1lbnQgb2YgTEJzXG4gICAgLy8gVGhlIHNhbWUgdmFsaWRhdGlvbiBoYXBwZW5zIGxhdGVyIG9uIGR1cmluZyB0aGUgYWN0dWFsIGF0dGFjaG1lbnRcbiAgICAvLyBvZiBMQnMsIGJ1dCB3ZSBuZWVkIHRoZSBwcm9wZXJ0eSBmb3IgdGhlIGNvcnJlY3QgY29uZmlndXJhdGlvbiBvZlxuICAgIC8vIHJvdXRpbmdQb2xpY3kgYW55d2F5LCBzbyBtaWdodCBhcyB3ZWxsIGRvIHRoZSB2YWxpZGF0aW9uIGFzIHdlbGwuXG4gICAgaWYgKHByb3BzLnJvdXRpbmdQb2xpY3kgPT09IFJvdXRpbmdQb2xpY3kuTXVsdGl2YWx1ZVxuICAgICAgICAmJiBwcm9wcy5sb2FkQmFsYW5jZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlZ2lzdGVyIGxvYWRiYWxhbmNlcnMgd2hlbiByb3V0aW5nIHBvbGljeSBpcyBgTXVsdGl2YWx1ZWAuJyk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLmhlYWx0aENoZWNrXG4gICAgICAgICYmIHByb3BzLmhlYWx0aENoZWNrLnR5cGUgPT09IEhlYWx0aENoZWNrVHlwZS5UY3BcbiAgICAgICAgJiYgcHJvcHMuaGVhbHRoQ2hlY2sucmVzb3VyY2VQYXRoKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc3BlY2lmeSBgcmVzb3VyY2VQYXRoYCB3aGVuIHVzaW5nIGEgYFRDUGAgaGVhbHRoIGNoZWNrLicpO1xuICAgIH1cblxuICAgIC8vIFNldCBkZWZhdWx0cyB3aGVyZSBuZWNlc3NhcnlcbiAgICBjb25zdCByb3V0aW5nUG9saWN5ID0gKHByb3BzLmRuc1JlY29yZFR5cGUgPT09IERuc1JlY29yZFR5cGUuQ05BTUUpIHx8IHByb3BzLmxvYWRCYWxhbmNlclxuICAgICAgPyBSb3V0aW5nUG9saWN5LldlaWdodGVkXG4gICAgICA6IFJvdXRpbmdQb2xpY3kuTXVsdGl2YWx1ZTtcblxuICAgIGNvbnN0IGRuc1JlY29yZFR5cGUgPSBwcm9wcy5kbnNSZWNvcmRUeXBlIHx8IERuc1JlY29yZFR5cGUuQTtcblxuICAgIGlmIChwcm9wcy5sb2FkQmFsYW5jZXJcbiAgICAgICYmICghKGRuc1JlY29yZFR5cGUgPT09IERuc1JlY29yZFR5cGUuQVxuICAgICAgICB8fCBkbnNSZWNvcmRUeXBlID09PSBEbnNSZWNvcmRUeXBlLkFBQUFcbiAgICAgICAgfHwgZG5zUmVjb3JkVHlwZSA9PT0gRG5zUmVjb3JkVHlwZS5BX0FBQUEpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXN0IHN1cHBvcnQgYEFgIG9yIGBBQUFBYCByZWNvcmRzIHRvIHJlZ2lzdGVyIGxvYWRiYWxhbmNlcnMuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgZG5zQ29uZmlnOiBDZm5TZXJ2aWNlLkRuc0NvbmZpZ1Byb3BlcnR5IHwgdW5kZWZpbmVkID0gcHJvcHMubmFtZXNwYWNlLnR5cGUgPT09IE5hbWVzcGFjZVR5cGUuSHR0cFxuICAgICAgPyB1bmRlZmluZWRcbiAgICAgIDoge1xuICAgICAgICAgIGRuc1JlY29yZHM6IHJlbmRlckRuc1JlY29yZHMoZG5zUmVjb3JkVHlwZSwgcHJvcHMuZG5zVHRsU2VjKSxcbiAgICAgICAgICBuYW1lc3BhY2VJZDogcHJvcHMubmFtZXNwYWNlLm5hbWVzcGFjZUlkLFxuICAgICAgICAgIHJvdXRpbmdQb2xpY3ksXG4gICAgICAgIH07XG5cbiAgICBjb25zdCBoZWFsdGhDaGVja0NvbmZpZ0RlZmF1bHRzID0ge1xuICAgICAgdHlwZTogSGVhbHRoQ2hlY2tUeXBlLkh0dHAsXG4gICAgICBmYWlsdXJlVGhyZXNob2xkOiAxLFxuICAgICAgcmVzb3VyY2VQYXRoOiBwcm9wcy5oZWFsdGhDaGVjayAmJiBwcm9wcy5oZWFsdGhDaGVjay50eXBlICE9PSBIZWFsdGhDaGVja1R5cGUuVGNwXG4gICAgICAgID8gJy8nXG4gICAgICAgIDogdW5kZWZpbmVkXG4gICAgfTtcblxuICAgIGNvbnN0IGhlYWx0aENoZWNrQ29uZmlnID0gcHJvcHMuaGVhbHRoQ2hlY2sgJiYgeyAuLi5oZWFsdGhDaGVja0NvbmZpZ0RlZmF1bHRzLCAuLi5wcm9wcy5oZWFsdGhDaGVjayB9O1xuICAgIGNvbnN0IGhlYWx0aENoZWNrQ3VzdG9tQ29uZmlnID0gcHJvcHMuY3VzdG9tSGVhbHRoQ2hlY2s7XG5cbiAgICAvLyBDcmVhdGUgc2VydmljZVxuICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgQ2ZuU2VydmljZSh0aGlzLCAnUmVzb3VyY2UnLCB7XG4gICAgICBuYW1lOiBwcm9wcy5uYW1lLFxuICAgICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uLFxuICAgICAgZG5zQ29uZmlnLFxuICAgICAgaGVhbHRoQ2hlY2tDb25maWcsXG4gICAgICBoZWFsdGhDaGVja0N1c3RvbUNvbmZpZyxcbiAgICAgIG5hbWVzcGFjZUlkOiBwcm9wcy5uYW1lc3BhY2UubmFtZXNwYWNlSWRcbiAgICB9KTtcblxuICAgIHRoaXMuc2VydmljZU5hbWUgPSBzZXJ2aWNlLnNlcnZpY2VOYW1lO1xuICAgIHRoaXMuc2VydmljZUFybiA9IHNlcnZpY2Uuc2VydmljZUFybjtcbiAgICB0aGlzLnNlcnZpY2VJZCA9IHNlcnZpY2Uuc2VydmljZUlkO1xuICAgIHRoaXMubmFtZXNwYWNlID0gcHJvcHMubmFtZXNwYWNlO1xuICAgIHRoaXMuZG5zUmVjb3JkVHlwZSA9IGRuc1JlY29yZFR5cGU7XG4gICAgdGhpcy5yb3V0aW5nUG9saWN5ID0gcm91dGluZ1BvbGljeTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlcnMgYW4gRUxCIGFzIGEgbmV3IGluc3RhbmNlIHdpdGggdW5pcXVlIG5hbWUgaW5zdGFuY2VJZCBpbiB0aGlzIHNlcnZpY2UuXG4gICAqL1xuICBwdWJsaWMgcmVnaXN0ZXJMb2FkQmFsYW5jZXIoaWQ6IHN0cmluZywgbG9hZEJhbGFuY2VyOiByb3V0ZTUzLklBbGlhc1JlY29yZFRhcmdldCwgY3VzdG9tQXR0cmlidXRlcz86IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9KTogSUluc3RhbmNlIHtcbiAgICByZXR1cm4gbmV3IEFsaWFzVGFyZ2V0SW5zdGFuY2UodGhpcywgaWQsIHtcbiAgICAgIHNlcnZpY2U6IHRoaXMsXG4gICAgICBkbnNOYW1lOiBsb2FkQmFsYW5jZXIuYXNBbGlhc1JlY29yZFRhcmdldCgpLmRuc05hbWUsXG4gICAgICBjdXN0b21BdHRyaWJ1dGVzXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0ZXJzIGEgcmVzb3VyY2UgdGhhdCBpcyBhY2Nlc3NpYmxlIHVzaW5nIHZhbHVlcyBvdGhlciB0aGFuIGFuIElQIGFkZHJlc3Mgb3IgYSBkb21haW4gbmFtZSAoQ05BTUUpLlxuICAgKi9cbiAgcHVibGljIHJlZ2lzdGVyTm9uSXBJbnN0YW5jZShwcm9wczogTm9uSXBJbnN0YW5jZUJhc2VQcm9wcyk6IElJbnN0YW5jZSB7XG4gICAgcmV0dXJuIG5ldyBOb25JcEluc3RhbmNlKHRoaXMsIFwiTm9uSXBJbnN0YW5jZVwiLCB7XG4gICAgICBzZXJ2aWNlOiB0aGlzLFxuICAgICAgaW5zdGFuY2VJZDogcHJvcHMuaW5zdGFuY2VJZCxcbiAgICAgIGN1c3RvbUF0dHJpYnV0ZXM6IHByb3BzLmN1c3RvbUF0dHJpYnV0ZXNcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlcnMgYSByZXNvdXJjZSB0aGF0IGlzIGFjY2Vzc2libGUgdXNpbmcgYW4gSVAgYWRkcmVzcy5cbiAgICovXG4gIHB1YmxpYyByZWdpc3RlcklwSW5zdGFuY2UocHJvcHM6IElwSW5zdGFuY2VCYXNlUHJvcHMpOiBJSW5zdGFuY2Uge1xuICAgIHJldHVybiBuZXcgSXBJbnN0YW5jZSh0aGlzLCBcIklwSW5zdGFuY2VcIiwge1xuICAgICAgc2VydmljZTogdGhpcyxcbiAgICAgIGluc3RhbmNlSWQ6IHByb3BzLmluc3RhbmNlSWQsXG4gICAgICBpcHY0OiBwcm9wcy5pcHY0LFxuICAgICAgaXB2NjogcHJvcHMuaXB2NixcbiAgICAgIHBvcnQ6IHByb3BzLnBvcnQsXG4gICAgICBjdXN0b21BdHRyaWJ1dGVzOiBwcm9wcy5jdXN0b21BdHRyaWJ1dGVzXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0ZXJzIGEgcmVzb3VyY2UgdGhhdCBpcyBhY2Nlc3NpYmxlIHVzaW5nIGEgQ05BTUUuXG4gICAqL1xuICBwdWJsaWMgcmVnaXN0ZXJDbmFtZUluc3RhbmNlKHByb3BzOiBDbmFtZUluc3RhbmNlQmFzZVByb3BzKTogSUluc3RhbmNlIHtcbiAgICByZXR1cm4gbmV3IENuYW1lSW5zdGFuY2UodGhpcywgXCJDbmFtZUluc3RhbmNlXCIsIHtcbiAgICAgIHNlcnZpY2U6IHRoaXMsXG4gICAgICBpbnN0YW5jZUlkOiBwcm9wcy5pbnN0YW5jZUlkLFxuICAgICAgaW5zdGFuY2VDbmFtZTogcHJvcHMuaW5zdGFuY2VDbmFtZSxcbiAgICAgIGN1c3RvbUF0dHJpYnV0ZXM6IHByb3BzLmN1c3RvbUF0dHJpYnV0ZXNcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZW5kZXJEbnNSZWNvcmRzKGRuc1JlY29yZFR5cGU6IERuc1JlY29yZFR5cGUsIGRuc1R0bFNlYz86IG51bWJlcik6IENmblNlcnZpY2UuRG5zUmVjb3JkUHJvcGVydHlbXSB7XG4gIGNvbnN0IHR0bCA9IGRuc1R0bFNlYyAhPT0gdW5kZWZpbmVkID8gZG5zVHRsU2VjIDogNjA7XG5cbiAgaWYgKGRuc1JlY29yZFR5cGUgPT09IERuc1JlY29yZFR5cGUuQV9BQUFBKSB7XG4gICAgcmV0dXJuIFt7XG4gICAgICB0eXBlOiBEbnNSZWNvcmRUeXBlLkEsXG4gICAgICB0dGxcbiAgICB9LCB7XG4gICAgICB0eXBlOiBEbnNSZWNvcmRUeXBlLkFBQUEsXG4gICAgICB0dGwsXG4gICAgfV07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFt7IHR5cGU6IGRuc1JlY29yZFR5cGUsIHR0bCB9XTtcbiAgfVxufVxuXG4vKipcbiAqIFNldHRpbmdzIGZvciBhbiBvcHRpb25hbCBBbWF6b24gUm91dGUgNTMgaGVhbHRoIGNoZWNrLiBJZiB5b3Ugc3BlY2lmeSBzZXR0aW5ncyBmb3IgYSBoZWFsdGggY2hlY2ssIEFXUyBDbG91ZCBNYXBcbiAqIGFzc29jaWF0ZXMgdGhlIGhlYWx0aCBjaGVjayB3aXRoIGFsbCB0aGUgcmVjb3JkcyB0aGF0IHlvdSBzcGVjaWZ5IGluIERuc0NvbmZpZy4gT25seSB2YWxpZCB3aXRoIGEgUHVibGljRG5zTmFtZXNwYWNlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhlYWx0aENoZWNrQ29uZmlnIHtcbiAgLyoqXG4gICAqIFRoZSB0eXBlIG9mIGhlYWx0aCBjaGVjayB0aGF0IHlvdSB3YW50IHRvIGNyZWF0ZSwgd2hpY2ggaW5kaWNhdGVzIGhvdyBSb3V0ZSA1MyBkZXRlcm1pbmVzIHdoZXRoZXIgYW4gZW5kcG9pbnQgaXNcbiAgICogaGVhbHRoeS4gQ2Fubm90IGJlIG1vZGlmaWVkIG9uY2UgY3JlYXRlZC4gU3VwcG9ydGVkIHZhbHVlcyBhcmUgSFRUUCwgSFRUUFMsIGFuZCBUQ1AuXG4gICAqXG4gICAqIEBkZWZhdWx0IEhUVFBcbiAgICovXG4gIHJlYWRvbmx5IHR5cGU/OiBIZWFsdGhDaGVja1R5cGU7XG5cbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRoYXQgeW91IHdhbnQgUm91dGUgNTMgdG8gcmVxdWVzdCB3aGVuIHBlcmZvcm1pbmcgaGVhbHRoIGNoZWNrcy4gRG8gbm90IHVzZSB3aGVuIGhlYWx0aCBjaGVjayB0eXBlIGlzIFRDUC5cbiAgICpcbiAgICogQGRlZmF1bHQgJy8nXG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZVBhdGg/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBudW1iZXIgb2YgY29uc2VjdXRpdmUgaGVhbHRoIGNoZWNrcyB0aGF0IGFuIGVuZHBvaW50IG11c3QgcGFzcyBvciBmYWlsIGZvciBSb3V0ZSA1MyB0byBjaGFuZ2UgdGhlIGN1cnJlbnRcbiAgICogc3RhdHVzIG9mIHRoZSBlbmRwb2ludCBmcm9tIHVuaGVhbHRoeSB0byBoZWFsdGh5IG9yIHZpY2UgdmVyc2EuXG4gICAqXG4gICAqIEBkZWZhdWx0IDFcbiAgICovXG4gIHJlYWRvbmx5IGZhaWx1cmVUaHJlc2hvbGQ/OiBudW1iZXI7XG59XG5cbi8qKlxuICogU3BlY2lmaWVzIGluZm9ybWF0aW9uIGFib3V0IGFuIG9wdGlvbmFsIGN1c3RvbSBoZWFsdGggY2hlY2suXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSGVhbHRoQ2hlY2tDdXN0b21Db25maWcge1xuICAvKipcbiAgICogVGhlIG51bWJlciBvZiAzMC1zZWNvbmQgaW50ZXJ2YWxzIHRoYXQgeW91IHdhbnQgQ2xvdWQgTWFwIHRvIHdhaXQgYWZ0ZXIgcmVjZWl2aW5nIGFuXG4gICAqIFVwZGF0ZUluc3RhbmNlQ3VzdG9tSGVhbHRoU3RhdHVzIHJlcXVlc3QgYmVmb3JlIGl0IGNoYW5nZXMgdGhlIGhlYWx0aCBzdGF0dXMgb2YgYSBzZXJ2aWNlIGluc3RhbmNlLlxuICAgKlxuICAgKiBAZGVmYXVsdCAxXG4gICAqL1xuICByZWFkb25seSBmYWlsdXJlVGhyZXNob2xkPzogbnVtYmVyO1xufVxuXG5leHBvcnQgZW51bSBEbnNSZWNvcmRUeXBlIHtcbiAgLyoqXG4gICAqIEFuIEEgcmVjb3JkXG4gICAqL1xuICBBID0gXCJBXCIsXG5cbiAgLyoqXG4gICAqIEFuIEFBQUEgcmVjb3JkXG4gICAqL1xuICBBQUFBID0gXCJBQUFBXCIsXG5cbiAgLyoqXG4gICAqIEJvdGggYW4gQSBhbmQgQUFBQSByZWNvcmRcbiAgICovXG4gIEFfQUFBQSA9IFwiQSwgQUFBQVwiLFxuXG4gIC8qKlxuICAgKiBBIFNydiByZWNvcmRcbiAgICovXG4gIFNSViA9IFwiU1JWXCIsXG5cbiAgLyoqXG4gICAqIEEgQ05BTUUgcmVjb3JkXG4gICAqL1xuICBDTkFNRSA9IFwiQ05BTUVcIixcbn1cblxuZXhwb3J0IGVudW0gUm91dGluZ1BvbGljeSB7XG4gIC8qKlxuICAgKiBSb3V0ZSA1MyByZXR1cm5zIHRoZSBhcHBsaWNhYmxlIHZhbHVlIGZyb20gb25lIHJhbmRvbWx5IHNlbGVjdGVkIGluc3RhbmNlIGZyb20gYW1vbmcgdGhlIGluc3RhbmNlcyB0aGF0IHlvdVxuICAgKiByZWdpc3RlcmVkIHVzaW5nIHRoZSBzYW1lIHNlcnZpY2UuXG4gICAqL1xuICBXZWlnaHRlZCA9IFwiV0VJR0hURURcIixcblxuICAvKipcbiAgICogSWYgeW91IGRlZmluZSBhIGhlYWx0aCBjaGVjayBmb3IgdGhlIHNlcnZpY2UgYW5kIHRoZSBoZWFsdGggY2hlY2sgaXMgaGVhbHRoeSwgUm91dGUgNTMgcmV0dXJucyB0aGUgYXBwbGljYWJsZSB2YWx1ZVxuICAgKiBmb3IgdXAgdG8gZWlnaHQgaW5zdGFuY2VzLlxuICAgKi9cbiAgTXVsdGl2YWx1ZSA9IFwiTVVMVElWQUxVRVwiLFxufVxuXG5leHBvcnQgZW51bSBIZWFsdGhDaGVja1R5cGUge1xuICAvKipcbiAgICogUm91dGUgNTMgdHJpZXMgdG8gZXN0YWJsaXNoIGEgVENQIGNvbm5lY3Rpb24uIElmIHN1Y2Nlc3NmdWwsIFJvdXRlIDUzIHN1Ym1pdHMgYW4gSFRUUCByZXF1ZXN0IGFuZCB3YWl0cyBmb3IgYW4gSFRUUFxuICAgKiBzdGF0dXMgY29kZSBvZiAyMDAgb3IgZ3JlYXRlciBhbmQgbGVzcyB0aGFuIDQwMC5cbiAgICovXG4gIEh0dHAgPSBcIkhUVFBcIixcblxuICAvKipcbiAgICogUm91dGUgNTMgdHJpZXMgdG8gZXN0YWJsaXNoIGEgVENQIGNvbm5lY3Rpb24uIElmIHN1Y2Nlc3NmdWwsIFJvdXRlIDUzIHN1Ym1pdHMgYW4gSFRUUFMgcmVxdWVzdCBhbmQgd2FpdHMgZm9yIGFuXG4gICAqIEhUVFAgc3RhdHVzIGNvZGUgb2YgMjAwIG9yIGdyZWF0ZXIgYW5kIGxlc3MgdGhhbiA0MDAuICBJZiB5b3Ugc3BlY2lmeSBIVFRQUyBmb3IgdGhlIHZhbHVlIG9mIFR5cGUsIHRoZSBlbmRwb2ludFxuICAgKiBtdXN0IHN1cHBvcnQgVExTIHYxLjAgb3IgbGF0ZXIuXG4gICAqL1xuICBIdHRwcyA9IFwiSFRUUFNcIixcblxuICAvKipcbiAgICogUm91dGUgNTMgdHJpZXMgdG8gZXN0YWJsaXNoIGEgVENQIGNvbm5lY3Rpb24uXG4gICAqIElmIHlvdSBzcGVjaWZ5IFRDUCBmb3IgVHlwZSwgZG9uJ3Qgc3BlY2lmeSBhIHZhbHVlIGZvciBSZXNvdXJjZVBhdGguXG4gICAqL1xuICBUY3AgPSBcIlRDUFwiLFxufVxuIl19