"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const elbv2 = require("@aws-cdk/aws-elasticloadbalancingv2");
const cdk = require("@aws-cdk/cdk");
var LoadBalancerType;
(function (LoadBalancerType) {
    LoadBalancerType[LoadBalancerType["Application"] = 0] = "Application";
    LoadBalancerType[LoadBalancerType["Network"] = 1] = "Network";
})(LoadBalancerType = exports.LoadBalancerType || (exports.LoadBalancerType = {}));
/**
 * Base class for load-balanced Fargate and ECS service
 */
class LoadBalancedServiceBase extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Load balancer
        this.loadBalancerType = props.loadBalancerType !== undefined ? props.loadBalancerType : LoadBalancerType.Application;
        if (this.loadBalancerType !== LoadBalancerType.Application && this.loadBalancerType !== LoadBalancerType.Network) {
            throw new Error(`invalid loadBalancerType`);
        }
        const internetFacing = props.publicLoadBalancer !== undefined ? props.publicLoadBalancer : true;
        const lbProps = {
            vpc: props.cluster.vpc,
            internetFacing
        };
        if (this.loadBalancerType === LoadBalancerType.Application) {
            this.loadBalancer = new elbv2.ApplicationLoadBalancer(this, 'LB', lbProps);
        }
        else {
            this.loadBalancer = new elbv2.NetworkLoadBalancer(this, 'LB', lbProps);
        }
        const targetProps = {
            port: 80
        };
        const hasCertificate = props.certificate !== undefined;
        if (hasCertificate && this.loadBalancerType !== LoadBalancerType.Application) {
            throw new Error("Cannot add certificate to an NLB");
        }
        if (this.loadBalancerType === LoadBalancerType.Application) {
            this.listener = this.loadBalancer.addListener('PublicListener', {
                port: hasCertificate ? 443 : 80,
                open: true
            });
            this.targetGroup = this.listener.addTargets('ECS', targetProps);
            if (props.certificate !== undefined) {
                this.listener.addCertificateArns('Arns', [props.certificate.certificateArn]);
            }
        }
        else {
            this.listener = this.loadBalancer.addListener('PublicListener', { port: 80 });
            this.targetGroup = this.listener.addTargets('ECS', targetProps);
        }
        new cdk.CfnOutput(this, 'LoadBalancerDNS', { value: this.loadBalancer.dnsName });
    }
    addServiceAsTarget(service) {
        if (this.loadBalancerType === LoadBalancerType.Application) {
            this.targetGroup.addTarget(service);
        }
        else {
            this.targetGroup.addTarget(service);
        }
    }
}
exports.LoadBalancedServiceBase = LoadBalancedServiceBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1iYWxhbmNlZC1zZXJ2aWNlLWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2FkLWJhbGFuY2VkLXNlcnZpY2UtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZEQUE4RDtBQUM5RCxvQ0FBcUM7QUFLckMsSUFBWSxnQkFHWDtBQUhELFdBQVksZ0JBQWdCO0lBQzFCLHFFQUFXLENBQUE7SUFDWCw2REFBTyxDQUFBO0FBQ1QsQ0FBQyxFQUhXLGdCQUFnQixHQUFoQix3QkFBZ0IsS0FBaEIsd0JBQWdCLFFBRzNCO0FBc0REOztHQUVHO0FBQ0gsTUFBc0IsdUJBQXdCLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFTakUsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFtQztRQUMvRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFFckgsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEtBQUssZ0JBQWdCLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUU7WUFDL0csTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1NBQzlDO1FBRUQsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFFaEcsTUFBTSxPQUFPLEdBQUc7WUFDZCxHQUFHLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHO1lBQ3RCLGNBQWM7U0FDZixDQUFDO1FBRUYsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEtBQUssZ0JBQWdCLENBQUMsV0FBVyxFQUFFO1lBQzFELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxLQUFLLENBQUMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztTQUM1RTthQUFNO1lBQ0wsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3hFO1FBRUQsTUFBTSxXQUFXLEdBQUc7WUFDbEIsSUFBSSxFQUFFLEVBQUU7U0FDVCxDQUFDO1FBRUYsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUM7UUFDdkQsSUFBSSxjQUFjLElBQUksSUFBSSxDQUFDLGdCQUFnQixLQUFLLGdCQUFnQixDQUFDLFdBQVcsRUFBRTtZQUM1RSxNQUFNLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7U0FDckQ7UUFFRCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUU7WUFDMUQsSUFBSSxDQUFDLFFBQVEsR0FBSSxJQUFJLENBQUMsWUFBOEMsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ2pHLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDL0IsSUFBSSxFQUFFLElBQUk7YUFDWCxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztZQUVoRSxJQUFJLEtBQUssQ0FBQyxXQUFXLEtBQUssU0FBUyxFQUFFO2dCQUNuQyxJQUFJLENBQUMsUUFBUSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQzthQUM5RTtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsUUFBUSxHQUFJLElBQUksQ0FBQyxZQUEwQyxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzdHLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ2pFO1FBRUQsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUVTLGtCQUFrQixDQUFDLE9BQW9CO1FBQy9DLElBQUksSUFBSSxDQUFDLGdCQUFnQixLQUFLLGdCQUFnQixDQUFDLFdBQVcsRUFBRTtZQUN6RCxJQUFJLENBQUMsV0FBNEMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDdkU7YUFBTTtZQUNKLElBQUksQ0FBQyxXQUF3QyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUNuRTtJQUNILENBQUM7Q0FDRjtBQWxFRCwwREFrRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJQ2VydGlmaWNhdGUgfSBmcm9tICdAYXdzLWNkay9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyJztcbmltcG9ydCBlbGJ2MiA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1lbGFzdGljbG9hZGJhbGFuY2luZ3YyJyk7XG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY2RrJyk7XG5pbXBvcnQgeyBCYXNlU2VydmljZSB9IGZyb20gJy4vYmFzZS9iYXNlLXNlcnZpY2UnO1xuaW1wb3J0IHsgSUNsdXN0ZXIgfSBmcm9tICcuL2NsdXN0ZXInO1xuaW1wb3J0IHsgQ29udGFpbmVySW1hZ2UgfSBmcm9tICcuL2NvbnRhaW5lci1pbWFnZSc7XG5cbmV4cG9ydCBlbnVtIExvYWRCYWxhbmNlclR5cGUge1xuICBBcHBsaWNhdGlvbixcbiAgTmV0d29ya1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExvYWRCYWxhbmNlZFNlcnZpY2VCYXNlUHJvcHMge1xuICAvKipcbiAgICogVGhlIGNsdXN0ZXIgd2hlcmUgeW91ciBzZXJ2aWNlIHdpbGwgYmUgZGVwbG95ZWRcbiAgICovXG4gIHJlYWRvbmx5IGNsdXN0ZXI6IElDbHVzdGVyO1xuXG4gIC8qKlxuICAgKiBUaGUgaW1hZ2UgdG8gc3RhcnQuXG4gICAqL1xuICByZWFkb25seSBpbWFnZTogQ29udGFpbmVySW1hZ2U7XG5cbiAgLyoqXG4gICAqIFRoZSBjb250YWluZXIgcG9ydCBvZiB0aGUgYXBwbGljYXRpb24gbG9hZCBiYWxhbmNlciBhdHRhY2hlZCB0byB5b3VyIEZhcmdhdGUgc2VydmljZS4gQ29ycmVzcG9uZHMgdG8gY29udGFpbmVyIHBvcnQgbWFwcGluZy5cbiAgICpcbiAgICogQGRlZmF1bHQgODBcbiAgICovXG4gIHJlYWRvbmx5IGNvbnRhaW5lclBvcnQ/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgd2hldGhlciB0aGUgQXBwbGljYXRpb24gTG9hZCBCYWxhbmNlciB3aWxsIGJlIGludGVybmV0LWZhY2luZ1xuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBwdWJsaWNMb2FkQmFsYW5jZXI/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBOdW1iZXIgb2YgZGVzaXJlZCBjb3BpZXMgb2YgcnVubmluZyB0YXNrc1xuICAgKlxuICAgKiBAZGVmYXVsdCAxXG4gICAqL1xuICByZWFkb25seSBkZXNpcmVkQ291bnQ/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gY3JlYXRlIGFuIGFwcGxpY2F0aW9uIGxvYWQgYmFsYW5jZXIgb3IgYSBuZXR3b3JrIGxvYWQgYmFsYW5jZXJcbiAgICogQGRlZmF1bHQgYXBwbGljYXRpb25cbiAgICovXG4gIHJlYWRvbmx5IGxvYWRCYWxhbmNlclR5cGU/OiBMb2FkQmFsYW5jZXJUeXBlXG5cbiAgLyoqXG4gICAqIENlcnRpZmljYXRlIE1hbmFnZXIgY2VydGlmaWNhdGUgdG8gYXNzb2NpYXRlIHdpdGggdGhlIGxvYWQgYmFsYW5jZXIuXG4gICAqIFNldHRpbmcgdGhpcyBvcHRpb24gd2lsbCBzZXQgdGhlIGxvYWQgYmFsYW5jZXIgcG9ydCB0byA0NDMuXG4gICAqL1xuICByZWFkb25seSBjZXJ0aWZpY2F0ZT86IElDZXJ0aWZpY2F0ZTtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRvIHBhc3MgdG8gdGhlIGNvbnRhaW5lclxuICAgKlxuICAgKiBAZGVmYXVsdCBObyBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICovXG4gIHJlYWRvbmx5IGVudmlyb25tZW50PzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfTtcbn1cblxuLyoqXG4gKiBCYXNlIGNsYXNzIGZvciBsb2FkLWJhbGFuY2VkIEZhcmdhdGUgYW5kIEVDUyBzZXJ2aWNlXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBMb2FkQmFsYW5jZWRTZXJ2aWNlQmFzZSBleHRlbmRzIGNkay5Db25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgbG9hZEJhbGFuY2VyVHlwZTogTG9hZEJhbGFuY2VyVHlwZTtcblxuICBwdWJsaWMgcmVhZG9ubHkgbG9hZEJhbGFuY2VyOiBlbGJ2Mi5CYXNlTG9hZEJhbGFuY2VyO1xuXG4gIHB1YmxpYyByZWFkb25seSBsaXN0ZW5lcjogZWxidjIuQXBwbGljYXRpb25MaXN0ZW5lciB8IGVsYnYyLk5ldHdvcmtMaXN0ZW5lcjtcblxuICBwdWJsaWMgcmVhZG9ubHkgdGFyZ2V0R3JvdXA6IGVsYnYyLkFwcGxpY2F0aW9uVGFyZ2V0R3JvdXAgfCBlbGJ2Mi5OZXR3b3JrVGFyZ2V0R3JvdXA7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IGNkay5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBMb2FkQmFsYW5jZWRTZXJ2aWNlQmFzZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8vIExvYWQgYmFsYW5jZXJcbiAgICB0aGlzLmxvYWRCYWxhbmNlclR5cGUgPSBwcm9wcy5sb2FkQmFsYW5jZXJUeXBlICE9PSB1bmRlZmluZWQgPyBwcm9wcy5sb2FkQmFsYW5jZXJUeXBlIDogTG9hZEJhbGFuY2VyVHlwZS5BcHBsaWNhdGlvbjtcblxuICAgIGlmICh0aGlzLmxvYWRCYWxhbmNlclR5cGUgIT09IExvYWRCYWxhbmNlclR5cGUuQXBwbGljYXRpb24gJiYgdGhpcy5sb2FkQmFsYW5jZXJUeXBlICE9PSBMb2FkQmFsYW5jZXJUeXBlLk5ldHdvcmspIHtcbiAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgbG9hZEJhbGFuY2VyVHlwZWApO1xuICAgIH1cblxuICAgIGNvbnN0IGludGVybmV0RmFjaW5nID0gcHJvcHMucHVibGljTG9hZEJhbGFuY2VyICE9PSB1bmRlZmluZWQgPyBwcm9wcy5wdWJsaWNMb2FkQmFsYW5jZXIgOiB0cnVlO1xuXG4gICAgY29uc3QgbGJQcm9wcyA9IHtcbiAgICAgIHZwYzogcHJvcHMuY2x1c3Rlci52cGMsXG4gICAgICBpbnRlcm5ldEZhY2luZ1xuICAgIH07XG5cbiAgICBpZiAodGhpcy5sb2FkQmFsYW5jZXJUeXBlID09PSBMb2FkQmFsYW5jZXJUeXBlLkFwcGxpY2F0aW9uKSB7XG4gICAgICB0aGlzLmxvYWRCYWxhbmNlciA9IG5ldyBlbGJ2Mi5BcHBsaWNhdGlvbkxvYWRCYWxhbmNlcih0aGlzLCAnTEInLCBsYlByb3BzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2FkQmFsYW5jZXIgPSBuZXcgZWxidjIuTmV0d29ya0xvYWRCYWxhbmNlcih0aGlzLCAnTEInLCBsYlByb3BzKTtcbiAgICB9XG5cbiAgICBjb25zdCB0YXJnZXRQcm9wcyA9IHtcbiAgICAgIHBvcnQ6IDgwXG4gICAgfTtcblxuICAgIGNvbnN0IGhhc0NlcnRpZmljYXRlID0gcHJvcHMuY2VydGlmaWNhdGUgIT09IHVuZGVmaW5lZDtcbiAgICBpZiAoaGFzQ2VydGlmaWNhdGUgJiYgdGhpcy5sb2FkQmFsYW5jZXJUeXBlICE9PSBMb2FkQmFsYW5jZXJUeXBlLkFwcGxpY2F0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgYWRkIGNlcnRpZmljYXRlIHRvIGFuIE5MQlwiKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5sb2FkQmFsYW5jZXJUeXBlID09PSBMb2FkQmFsYW5jZXJUeXBlLkFwcGxpY2F0aW9uKSB7XG4gICAgICB0aGlzLmxpc3RlbmVyID0gKHRoaXMubG9hZEJhbGFuY2VyIGFzIGVsYnYyLkFwcGxpY2F0aW9uTG9hZEJhbGFuY2VyKS5hZGRMaXN0ZW5lcignUHVibGljTGlzdGVuZXInLCB7XG4gICAgICAgIHBvcnQ6IGhhc0NlcnRpZmljYXRlID8gNDQzIDogODAsXG4gICAgICAgIG9wZW46IHRydWVcbiAgICAgIH0pO1xuICAgICAgdGhpcy50YXJnZXRHcm91cCA9IHRoaXMubGlzdGVuZXIuYWRkVGFyZ2V0cygnRUNTJywgdGFyZ2V0UHJvcHMpO1xuXG4gICAgICBpZiAocHJvcHMuY2VydGlmaWNhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLmxpc3RlbmVyLmFkZENlcnRpZmljYXRlQXJucygnQXJucycsIFtwcm9wcy5jZXJ0aWZpY2F0ZS5jZXJ0aWZpY2F0ZUFybl0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxpc3RlbmVyID0gKHRoaXMubG9hZEJhbGFuY2VyIGFzIGVsYnYyLk5ldHdvcmtMb2FkQmFsYW5jZXIpLmFkZExpc3RlbmVyKCdQdWJsaWNMaXN0ZW5lcicsIHsgcG9ydDogODAgfSk7XG4gICAgICB0aGlzLnRhcmdldEdyb3VwID0gdGhpcy5saXN0ZW5lci5hZGRUYXJnZXRzKCdFQ1MnLCB0YXJnZXRQcm9wcyk7XG4gICAgfVxuXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0xvYWRCYWxhbmNlckROUycsIHsgdmFsdWU6IHRoaXMubG9hZEJhbGFuY2VyLmRuc05hbWUgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWRkU2VydmljZUFzVGFyZ2V0KHNlcnZpY2U6IEJhc2VTZXJ2aWNlKSB7XG4gICAgaWYgKHRoaXMubG9hZEJhbGFuY2VyVHlwZSA9PT0gTG9hZEJhbGFuY2VyVHlwZS5BcHBsaWNhdGlvbikge1xuICAgICAgKHRoaXMudGFyZ2V0R3JvdXAgYXMgZWxidjIuQXBwbGljYXRpb25UYXJnZXRHcm91cCkuYWRkVGFyZ2V0KHNlcnZpY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAodGhpcy50YXJnZXRHcm91cCBhcyBlbGJ2Mi5OZXR3b3JrVGFyZ2V0R3JvdXApLmFkZFRhcmdldChzZXJ2aWNlKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==